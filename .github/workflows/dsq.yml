name: Build and publish artifacts

on:
  workflow_dispatch

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@master
      with:
        ref: ${{ github.ref }}

    - run: ./scripts/prepare_windows.ps1
    - run: echo "GIT_TAG=$(git tag --points-at HEAD)" >> $Env:GITHUB_ENV
    - run: |
        echo "RELEASE_ID=$(curl -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' https://api.github.com/repos/jqk/scoop-cache-cleaner/releases/tags/$Env:GIT_TAG | jq '.id')" >> $Env:GITHUB_ENV
    - run: go build -trimpath -buildmode=pie -mod=readonly -modcacherw -ldflags "-s -w -X main.Version=$Env:GIT_TAG"
    - run: zip scc-win32-x64-$Env:GIT_TAG.zip scc.exe
    - name: Upload release
      run: |
        curl --fail -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/zip" --data-binary "@./scc-win32-x64-$Env:GIT_TAG.zip" "https://uploads.github.com/repos/jqk/scoop-cache-cleaner/releases/$Env:RELEASE_ID/assets?name=scc-win32-x64-$Env:GIT_TAG.zip"